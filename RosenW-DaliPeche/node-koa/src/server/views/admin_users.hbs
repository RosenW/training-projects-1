<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="./../bootstrap.css">
    <link rel="stylesheet" type="text/css" href="./../sidebar.css">
    <link rel="stylesheet" type="text/css" href="./../navbar.css">
  </head>
   <body>
    {{> navBar }}
    {{> adminMenu }}
    <ul class="list-group-item col-lg-9">
      <form class="inline">
        <div style="height: 20.8em"> <!-- testing -->
          <br>
          <label class="col-lg-12">Username:</label>
          <div class="col-lg-12">
            <input type="text" name="username" class="form-control" value="{{username}}">
          </div>
          <label class="col-lg-12">Date From/To:</label>
          <div class="col-lg-6">
            <input type="date" name="date-from" class="form-control" value="{{dateFrom}}">
          </div>
          <div class="col-lg-6">
            <input type="date" name="date-to" class="form-control" value="{{dateTo}}">
          </div>
            <label class="col-lg-12">Email:</label>
          <div class="col-lg-12">
            <input type="text" name="email" class="form-control" value="{{email}}">
          </div>
          <label class="col-lg-12">Credits From/To:</label>
          <div class="col-lg-6">
            <input type="text" name="credits-from" class="form-control" value="{{creditsFrom}}">
          </div>
          <div class="col-lg-6">
            <input type="text" name="credits-to" class="form-control" value="{{creditsTo}}">
          </div>
        </div>
        <div>
          <div class="col-lg-6">
            <button id="export-btn" class='form-control btn-info' onclick="exportToExcel(event)">Export</button>
          </div>
          <div class="col-lg-6">
            <input type="submit" id="search-btn" value="Search" class='form-control btn-success'>
          </div>
        </div>
      </form>
    </ul>
    <h3 class="col-lg-12 text-center">Report</h3>
    <table id="users-table" class="table table-hover table-bordered">
      <tr>
        <th>ID</th>
        <th>Date Registered</th>
        <th>User</th>
        <th>Email</th>
        <th>Successful Requests</th>
        <th>Failed Requests</th>
        <th>Credits</th>
      </tr>
      {{#each users}}
        <tr class="gen-tr">
          <td class="text-right">{{id}}</td>
          <td>{{date_registered}}</td>
          <td>{{username}}</td>
          <td>{{email}}</td>
          <td class="text-right">{{successful_requests}}</td>
          <td class="text-right">{{failed_requests}}</td>
          <td><input id="credits-{{username}}" type="text" value="{{credits}}" disabled="true" style="text-align: right">{{#if ../permissions.can_add_credits}}<a href="#" id="add-credits-sign-{{id}}" onclick='addCredits("{{username}}")'> +</a>{{/if}}</td>
        </tr>
      {{/each}}
    </table>
  </body>
</html>

<script type="text/javascript">
  document.getElementById('menu-users').setAttribute('class', 'selected');
  function exportToExcel (event) {
    event.preventDefault();
    let htmls = "";
    const uri = 'data:application/vnd.ms-excel;base64,';
    const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>';

    const base64 = function(s) {
        return window.btoa(unescape(encodeURIComponent(s)))
    };

    const format = function(s, c) {
        return s.replace(/{(\w+)}/g, (m, p) => {
            return c[p];
        })
    };

    const filterTable = document.createElement('table');

    const filterNameTH = document.createElement('th');
    filterNameTH.innerHTML = 'Filter';

    const filterValueTH = document.createElement('th');
    filterValueTH.innerHTML = 'Value';

    const filterNames = ['Username', 'Date From/To', 'Email', 'Credits From/To'];

    for (const filter of filterNames) {
      row =  document.createElement('');
    }

    // const usernameTD = document.createElement('td');
    // usernameTD.innerHTML = 'Username';

    // const dateTD = document.createElement('td');
    // dateTD.innerHTML = 'Date From/To';

    // const emailTD = document.createElement('td');
    // emailTD.innerHTML = 'Email';

    // const creditsTD = document.createElement('td');
    // creditsTD.innerHTML = 'Credits From/To';

    // const usernameValueTD = document.createElement('td');
    // usernameValueTD.innerHTML = '{{username}}';

    // const dateValueTD = document.createElement('td');
    // dateValueTD.innerHTML = '{{dateFrom}} - {{dateTo}}';

    // const emailValueTD = document.createElement('td');
    // emailValueTD.innerHTML = '{{email}}';

    // const creditsValueTD = document.createElement('td');
    // creditsValueTD.innerHTML = '{{credits}}';

    // filterTable.appendChild(filterNameTH);
    // filterTable.appendChild(filterValueTH);

    htmls = document.getElementById('users-table').innerHTML;

    const ctx = {
        worksheet : 'Worksheet',
        table : htmls
    }

    const link = document.createElement("a");
    link.download = "export.xls";
    link.href = uri + base64(format(template, ctx));
    link.click();
  }

  async function addCredits (username) {
    const credits = prompt(`add credits to user ${username}`);
    if (!Number(credits)) return;
    const response = await fetch('/admin/addCreditsToUser', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username,
        credits
      })
    });
    const data = await response.json();
    console.log(data);
    creditBox = document.getElementById(`credits-${username}`);
    creditBox.value = parseInt(creditBox.value) + parseInt(credits);
  }
</script>